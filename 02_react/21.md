<h1>Projeto Blog Pessoal - Implementando o Componente Formulário Temas</h1>

Com o componente de Cadastro de Temas construído, agora iremos implementar sua lógica, permitindo cadastrarmos novos temas e, editar os temas já criados em nosso Back End. 

Para isso, iremos consumir os endpoints de POST e PUT de Temas da nossa API, cujo as funções serão de criar novos temas - ao enviar uma solicitação com dados do tema no corpo, a API gera um novo registro no banco de dados e, atualizar os temas existentes - ao enviar uma solicitação com dados de um tema existente, a API busca o registro correspondente e o atualiza com os novos dados fornecidos. 



<h2><img src="https://i.imgur.com/izFuHID.png" title="source: imgur.com" width="4%"/>Passo 01 - Atualizar a Classe de Serviço - Service de Cadastro</h2>

Antes de adicionar a lógica de funcionamento no componente, precisamos antes construir a Service responsável por por Cadastrar novos Temas e Atualizar os já existentes.

1. Abra o arquivo **Service.ts** localizado dentro da pasta **service**.
2. Abaixo da **Service Buscar **, adicione as seguintes funções a seguir:

```tsx
export const cadastrar = async (url: string, dados: Object, setDados: Function, header: Object) => {
    const resposta = await api.post(url, dados, header)
    setDados(resposta.data)
}

export const atualizar = async (url: string, dados: Object, setDados: Function, header: Object) => {
    const resposta = await api.put(url, dados, header)
    setDados(resposta.data)
}
```

IMAGEM PRINT 90

**Linhas 22 a 25:** Construímos e exportamos uma função assíncrona, que se será nossa **service cadastrar**. Ela será responsável por cadastrar qualquer novo recurso em nossa aplicação.

**Linha 22:** Essa Arrow Function Assíncrona possui quatro argumentos:

- **url:** É uma string que representa o endpoint da API para onde a solicitação POST será feita. Essa URL será anexada à URL base definida anteriormente na instância do Axios (api).
- **dados:** É um objeto que representa os dados que serão enviados na solicitação POST. Esses dados serão enviados no corpo da solicitação HTTP.
- **setDados:** É uma função que será usada para atualizar os dados na sua aplicação com a resposta da solicitação.
- **header:** É um objeto que contém um cabeçalho HTTP, como informações de autenticação.

**Linha 23:** A palavra reservada **await** é usada para esperar a conclusão da solicitação que estamos executando, e somente após sua conclusão iremos continuar o fluxo da função. Nesta linha, fazemos uma solicitação POST para a **URL** especificada no parâmetro de mesmo nome através da instância do Axios, que chamamos de **api**. 

Dentro desta instância, além da URL, passamos o parâmetro **dados** que contém um objeto com as informações a serem persistidas na API. E o último parâmetro informado é o **header**, que contém o token do usuário autenticado, permitindo o acesso dessa função ao Back. 

**Linha 24:** Após a conclusão da solicitação, a resposta da API é armazenada na variável **resposta**. O código então chama a função **setDados**, passando **resposta.data como argumento**. Isso atualiza os dados na nossa aplicação com os dados retornados pela API após o login do usuário.

**Linhas 27 a 30:** Construímos e exportamos a função assíncrona denominada **atualizar**. Ela será responsável por atualizar qualquer recurso já existente em nossa aplicação.

**Linha 27:** Essa Arrow Function Assíncrona, assim como a service anterior, possui quatro argumentos:

- **url:** É uma string que representa o endpoint da API para onde a solicitação POST será feita. Essa URL será anexada à URL base definida anteriormente na instância do Axios (api).
- **dados:** É um objeto que representa os dados que serão enviados na solicitação POST. Esses dados serão enviados no corpo da solicitação HTTP.
- **setDados:** É uma função que será usada para atualizar os dados na sua aplicação com a resposta da solicitação.
- **header:** É um objeto que contém um cabeçalho HTTP, como informações de autenticação.

**Linha 28:** Iniciamos com a palavra reservada **await**, indicando que a lógica dessa função deve ser executada e concluída para que o fluxo da aplicação continue. Ainda nesta linha, fazemos uma solicitação agora do tipo **PUT** para a **URL** recebida como argumento da função, através da instância **api** do Axios.

Dentro desta instância, depois da URL, inserimos o parâmetro **dados** contendo um objeto com as informações do item a ser atualizado no Back End. Por último, informamos o parâmetro **header**, que contém o token do usuário autenticado, permitindo o acesso dessa função ao Back. 

**Linha 29:** Após a conclusão da solicitação, a resposta da API é armazenada na variável **resposta**. O código então chama a função **setDados**, passando **resposta.data como argumento**. Isso atualiza os dados na nossa aplicação com os dados retornados pela API após o login do usuário.

TABELA INDICANDO A SEMELHANÇA ENTRE O CADASTRAR E ATUALIZAR



| [![source: imgur.com](https://camo.githubusercontent.com/656a7f920290b1249ff1f60c486fa6cb7ad1af445115fac67cf14a9abd41a208/68747470733a2f2f692e696d6775722e636f6d2f684f67577653632e706e67)](https://camo.githubusercontent.com/656a7f920290b1249ff1f60c486fa6cb7ad1af445115fac67cf14a9abd41a208/68747470733a2f2f692e696d6775722e636f6d2f684f67577653632e706e67) | **ATENÇÃO:** *Observe que o código da service Buscar possui algumas diferenças em relação as services anteriores. A mais importante, é o uso do parâmetro HEADER. Esse parâmetro irá conter o Token de Autenticação do Usuário, e DEVE ser passado a essa função, já que as services que iremos construir daqui para frente, são todas protegidas pela Security do Spring, e precisam do Token JWT para autorizar a execução de determinada função.* |
| ------------------------------------------------------------ | ------------------------------------------------------------ |



<h2><img src="https://i.imgur.com/H9wEgsJ.png" title="source: imgur.com" width="5%"/>Passo 02 - Implementando a lógica do Componente Formulário Tema</h2>

Com as services que serão utilizadas em nosso formulário concluídas, agora partiremos para a adição da lógica desse componente. Portanto segui os passos abaixo:

<br>

1. Abra o componente **FormularioTema.tsx** localizado dentro da pasta **temas**.
1. Agora insira os códigos abaixo, nos locais indicados:

```tsx
import { ChangeEvent, useContext, useEffect, useState } from "react";
import { useNavigate, useParams } from "react-router-dom";

import { atualizar, buscar, cadastrar } from "../../../services/Service";
import { AuthContext } from "../../../contexts/AuthContext";

import Tema from "../../../models/Tema";

function FormularioTema() {
    const [tema, setTema] = useState<Tema>({} as Tema);

    const navigate = useNavigate();

    const { id } = useParams<{ id: string }>();

    const { usuario, handleLogout } = useContext(AuthContext);
    const token = usuario.token;

    async function buscarPorId(id: string) {
        await buscar(`/temas/${id}`, setTema, {
            headers: {
                Authorization: token,
            },
        });
    }

    useEffect(() => {
        if (token === '') {
            alert('Você precisa estar logado');
            navigate('/login');
        }
    }, [token]);

    useEffect(() => {
        if (id !== undefined) {
            buscarPorId(id)
        }
    }, [id])

    function atualizarEstado(e: ChangeEvent<HTMLInputElement>) {
        setTema({
            ...tema,
            [e.target.name]: e.target.value
        })
    }

    async function gerarNovoTema(e: ChangeEvent<HTMLFormElement>) {
        e.preventDefault()

        if (id !== undefined) {
            try {
                await atualizar(`/temas`, tema, setTema, {
                    headers: {
                        'Authorization': token
                    }
                })

                alert('Tema atualizado com sucesso')
                retornar()

            } catch (error: any) {
                if (error.toString().includes('403')) {
                    alert('O token expirou, favor logar novamente')
                    handleLogout()
                } else {
                    alert('Erro ao atualizar o Tema')
                }
            }

        } else {
            try {
                await cadastrar(`/temas`, tema, setTema, {
                    headers: {
                        'Authorization': token
                    }
                })

                alert('Tema cadastrado com sucesso')
                retornar()

            } catch (error: any) {
                if (error.toString().includes('403')) {
                    alert('O token expirou, favor logar novamente')
                    handleLogout()
                } else {
                    alert('Erro ao cadastrado o Tema')
                }
            }
        }

        retornar()
    }

    function retornar() {
        navigate("/temas")
    }

    return (
```

```tsx
<div className="container flex flex-col items-center justify-center mx-auto">
            <h1 className="text-4xl text-center my-8">
                {id === undefined ? 'Cadastrar Tema' : 'Editar tema'}
            </h1>

            <form className="w-1/2 flex flex-col gap-4" onSubmit={gerarNovoTema}>
                <div className="flex flex-col gap-2">
                    <label htmlFor="descricao">Descrição do Tema</label>
                    <input
                        type="text"
                        placeholder="Descreva aqui seu tema"
                        name='descricao'
                        className="border-2 border-slate-700 rounded p-2"
                        value={tema.descricao}
                        onChange={(e: ChangeEvent<HTMLInputElement>) => atualizarEstado(e)}
                    />
                </div>
                <button
                    className="rounded text-slate-100 bg-indigo-400 
                               hover:bg-indigo-800 w-1/2 py-2 mx-auto block"
                    type="submit"
                >
                    {id === undefined ? 'Cadastrar' : 'Editar'}
                </button>
            </form>
        </div>
    )
```

<br>

IMAGEM PRINT 91

IMAGEM PRINT 92

IMAGEM PRINT 93

IMAGEM PRINT 94

IMAGEM PRINT 95

<br>

**Vamos analisar as alterações efetuadas no código:**

**Linhas 1 e 2:** Fazemos as importações das Interfaces e Hooks de suas respectivas bibliotecas para dentro do Componente.

**Linhas 4 e 5:** Fazemos a importação das services **atualizar, buscar e cadastrar** e, do nosso **Contexto**.

**Linha 7:** Importamos a **model de Tema.**

**Linha 11:** Criamos um estado chamado **tema** que é inicializado como um objeto vazio do tipo **Tema** através do operador **as** (usado para fazer uma conversão de tipo, **indicando explicitamente ao TypeScript que o objeto vazio é do tipo informado**). A partir deste ponto, usamos esse estado para armazenar informações relacionadas ao tema - que será cadastrado ou atualizado - em nosso componente.

**Linha 13:** Criamos uma constante chamada **navigate** e indicamos que ela recebe o **hook useNavigate()**. Com isso, agora a variável **navigate consegue redirecionar a pessoa para outras rotas/componentes.**

**Linha 15:** Essa linha permite acessarmos o valor do parâmetro **id** presente na URL usando o hook **useParams**. **Essa variável id estará presente em nossa URL sempre que o usuário clicar no botão Editar na Listagem de Temas**. Com essa ação feita, automaticamente o usuário será redirecionado para essa página onde o hook useParams irá capturar a variável ID contendo o id do tema que será editado. 

* **const { id }**: Usando desestruturação de objetos, estamos extraindo o valor do parâmetro "id" da URL e atribuindo-o à variável **id**. A chave { id } corresponde ao nome do parâmetro que estamos interessados em acessar.

* **useParams<{ id: string }>()**: Aqui usamos o hook **useParams**, para acessar parâmetros passados na URL.

* **<{ id: string }>**: Aqui passamos a tipagem do parâmetro **id**, indicando que ele será uma string, garantindo que o valor extraído seja do tipo esperado.

**Linhas 17 e 18:** Nestas linhas, estamos acessando o nosso contexto **através do hook useContext informando o arquivo de contexto que ele deve acessar - AuthContext**. Feito isso, **desestruturamos os valores do contexto** para que essas propriedades possam ser usadas no componente. Em seguida, definimos uma constante chamada **token** e passamos o valor do token do usuário logado para ela.



<br>

<h2><img src="https://i.imgur.com/H9wEgsJ.png" title="source: imgur.com" width="5%"/>Passo 03 - Testando o Componente</h2>

1. Execute o projeto através do comando abaixo:

```bash
yarn dev
```

2. Pressione a tecla **o** do seu teclado para abrir o Projeto no Navegador
3. Com o projeto aberto, logue na aplicação e depois clique no local indicado na imagem

<br>

<div align="center"><img src="https://i.imgur.com/C3NDhTE.png" title="source: imgur.com" /></div>

<br>

4. E então, você será redirecionado a página de Formulário de Temas. Ele ainda não está funcional pois no próximo capítulo iremos adicionar sua lógica.

<br>

<div align="center"><img src="https://i.imgur.com/lDLcB7T.png" title="source: imgur.com" /></div>

<br>

5. Por fim, deslogue da aplicação.

<br /><br />
	

<div align="left"><a href="README.md"><img src="https://i.imgur.com/XMgF3gl.png" title="source: imgur.com" width="3%"/>Voltar</a></div>